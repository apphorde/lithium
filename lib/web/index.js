import{unref as e,isRef as t,ReactiveContext as n}from"@lithium/reactive";const s=["capture","once","passive","stop","prevent"],c=/^[a-zA-Z_][a-zA-Z0-9\-_:.]*$/,i=Object.getPrototypeOf((async()=>{})).constructor,r=new DOMParser,o=[],a=()=>{},l=Symbol("@@def");function d(e,{setup:t,template:s}){if(customElements.get(e))customElements.get(e)[l]={name:e,setup:t,template:s};else{class c extends HTMLElement{$el;connectedCallback(){const{setup:e,template:t}=c[l],s={element:this,componentSetup:e,nodes:t,$state:{},$stateKeys:[],$stateArgs:[],init:null,destroy:null,reactive:new n};this.$el=s,queueMicrotask((()=>u.init(s)))}disconnectedCallback(){!this.isConnected&&this.$el.destroy&&queueMicrotask(this.$el.destroy)}}c[l]={name:e,setup:t,template:s},customElements.define(e,c)}}class m{static attachHandler(e,t,n,s){e.addEventListener(t,(e=>{s.stop&&e.stopPropagation(),s.prevent&&e.preventDefault(),n(e)}),s)}static emitEvent(e,t,n){e.dispatchEvent(new CustomEvent(t,{detail:n}))}static setProperty(t,n,s){t[n]=e(s)}static setClassName(e,t,n){for(const s of t.split("."))e.classList.toggle(s,n)}static setStyle(e,t,n){e.style[t]=n}static setText(e,t){e.textContent=String(t)}static defineEvent(e,t){let n;Object.defineProperty(e,"on"+t.toLowerCase(),{get:()=>n,set(e){n=e}})}static compileExpression(e,t=[]){const n=r.parseFromString(e,"text/html").body.innerText.trim();return(e.startsWith("await")?i:Function)(...t,`return ${n}`)}static materialize(e,t,n){if("string"==typeof e){const n=document.createTextNode(e);return t(n),n}const[s,c=0,i=[]]=e;if("#"===s){const e=document.createDocumentFragment();return Array.isArray(i)&&i.length&&e.append(...i.map((e=>m.materialize(e,t,n)))),e}if("!"===s)return document.createComment(c);"svg"===s&&(n.ns="http://www.w3.org/2000/svg");const r=n.ns?document.createElementNS(n.ns,s):document.createElement(s);if(t(r,c),c)for(const e of c)m.setAttribute(r,e[0],e[1]);return"string"==typeof i&&r.append(m.materialize([i],t)),Array.isArray(i)&&i.length&&r.append(...i.map((e=>m.materialize(e,t,n)))),"svg"===s&&(n.ns=""),r}static setAttribute(e,t,n){c.test(t)&&("boolean"!=typeof n||!1!==n?e.setAttribute(t,String(n)):e.removeAttribute(t))}}class u{static async init(e){o.push(e);try{const{reactive:t}=e;!function(e){if(!document.head.querySelector(`[id="ce-${e}"]`)){const t=document.createElement("style");t.id="ce-"+e,t.innerText=e.toLowerCase()+"{display:block}",document.head.append(t)}}(e.element.nodeName),t.suspend(),u.createInstance(),u.createDom(),t.unsuspend(),t.check(),e.init&&await e.init()}catch(e){console.log("Failed to initialize component!",this,e)}o.pop()}static createInstance(){const e=p(),t=e.componentSetup(e,e.element);e.$state=e.reactive.watchDeep({...t,...e.$state}),e.$stateKeys=Object.keys(e.$state),e.$stateArgs=e.$stateKeys.map((t=>e.$state[t]))}static createDom(){const{element:e,nodes:t,$state:n}=p(),s=m.materialize(t,((e,t)=>u.createBindings(n,e,t)),{});e.innerHTML="",e.append(s)}static compileExpression(e,t){const{$stateKeys:n,$stateArgs:s}=p();return m.compileExpression(e,n).bind(t,...s)}static createBindings(e,t,n){t.nodeType!==t.TEXT_NODE?t.nodeType!==t.ELEMENT_NODE||u.createElementNodeBindings(e,t,n):u.createTextNodeBinding(e,t)}static createTextNodeBinding(e,t){const n=t.textContent;if(n.includes("${")||n.includes("{{")){const s="`"+n.replace(/\{\{([\s\S]+?)}}/g,((e,t)=>"${ "+t.trim()+" }"))+"`";t.textContent="";x(A(s,u.compileExpression(s,e)),(e=>m.setText(t,e)))}}static createElementNodeBindings(e,t,n){for(const s of n){const n=s[0].trim(),c=s[1].trim();":"!==n.charAt(0)?"@"!==n.charAt(0)?n.startsWith(".class.")?u.createElementNodeClassBinding(e,t,n,c):n.startsWith(".style.")?u.createElementNodeStyleBinding(e,t,n,c):"ref"!==n||u.createElementNodeRefBinding(e,t,n,c):u.createElementNodeEventBinding(e,t,n,c):u.createElementNodePropertyBinding(e,t,n,c)}}static createElementNodeEventBinding(e,t,n,c){const[i,...r]=n.slice(1).split("."),{$stateKeys:o,$stateArgs:a}=p(),l=m.compileExpression(c,[...o,"$event"]).bind(e,...a),d={};for(const e of s)d[e]=r.includes(e);m.attachHandler(t,i,(e=>{try{l(e)}catch(e){console.error("event failed",c,e)}}),d)}static createElementNodeRefBinding(e,n,s,c){const i=c.trim();t(e[i])&&(e[i].value=n)}static createElementNodeClassBinding(e,t,n,s){const c=n.replace(".class.","");x(A(s,u.compileExpression(s,e)),(e=>m.setClassName(t,c,e)))}static createElementNodeStyleBinding(e,t,n,s){const c=n.replace(".style.","");x(A(s,u.compileExpression(s,e)),(e=>m.setStyle(t,c,e)))}static createElementNodePropertyBinding(e,t,n,s){const c=n.slice(1);x(A(s,u.compileExpression(s,e)),(e=>m.setProperty(t,c,e)))}}function p(){return o[o.length-1]}function f(e,t,n){if(!1===n||t&&document.head.querySelector(`[id="css-${t}"]`))return;const s=document.createElement("link");s.rel="stylesheet",s.href=e,t&&(s.id="css-"+t),document.head.append(s)}function y(e,t,n){if(!1===n||t&&document.head.querySelector(`[id="js-${t}"]`))return;const s=document.createElement("script");s.src=e,t&&(s.id="js-"+t),document.head.append(s)}function g(e){p().init=e}function E(e){p().destroy=e}function h(e){const t=N();return x((()=>{const n=e();t.value!==n&&(t.value=n)})),t}function v(e){const t=p().element;for(const n of e)m.defineEvent(t,n);return(e,n)=>m.emitEvent(t,e,n)}function $(e){const t=Array.isArray(e)?e:Object.keys(e),n=p(),s=n.element,c=n.$state;for(const e of t){const t=N(s[e]);c[e]=t,Object.defineProperty(s,e,{get:()=>t.value,set(e){t.value=e}})}return new Proxy({__w:!0},{get:(e,t)=>"__w"===t||n.$state[t].value})}function x(e,t){return p().reactive.watch(e,t)}function N(e){return p().reactive.ref(e)}function A(t,n){return()=>{try{const t=n();return e(t)}catch(e){console.log(t,e)}}}export{m as DOM,l as DefineComponent,u as Runtime,h as computed,d as createComponent,v as defineEvents,$ as defineProps,p as getCurrentInstance,f as loadCss,y as loadScript,a as noop,E as onDestroy,g as onInit,N as ref,x as watch};
